<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tables Information</title>
    <link rel="stylesheet" type="text/css" href="/css/tables.css" />
    <link rel="stylesheet" type="text/css" href="/css/logs.css" />
    <link rel="stylesheet" type="text/css" href="/css/top-bar.css" />
    <link rel="stylesheet" type="text/css" href="/css/tooltip.css" />
    <link rel="stylesheet"  type="text/css" href="/css/select.css"/>

    <script>
        window.config = {
            schemaName: "{{.SchemaName}}"
        };
    </script>
    <script src="/js/table.js"></script>
    <script src="/js/query.js"></script>
    <script src="/js/download.js"></script>
    <script src="/js/cud_row.js" defer></script>
</head>

<body>
    <div class="full-screan">
        <div class="top-bar">
            <a href="/schemas">Back to Schemas</a>
            <button class="info-button" onclick="createSQLInput('{{.}}')">Create SQL Input</button>
            <a href="/{{.SchemaName}}/pre-join">To Join Tables</a>
            <a href="/{{.SchemaName}}/render-create-table">To Create Table</a>
            <a href="/{{.SchemaName}}/schema">To Tables Schema</a>
        </div>
        <div class="container">

            <ul class="table-list">
                {{range $index, $table := .Tables}}
                <li class="table-item">
                    <button class="button-table-name" onclick="getTableData('{{$table}}')">{{$table}}</button>
                    <button id="openPopupBtn-{{$index}}" class="btn-2  btn-export openPopupBtn">Export/Import</button>

                    <div id="popup-{{$index}}" class="popup">
                        <div class="popup-content">
                            <span id="closePopupBtn-{{$index}}" class="close">&times;</span>
                            <div class="section">
                                <h3>Export</h3>
                                <button class="btn-1 btn-export"
                                    onclick="downloadTableDataJson('{{$table}}')">Json</button>
                                <button class="btn-1 btn-download-cvs"
                                    onclick="downloadTableDataCSV('{{$table}}')">CSV</button>
                            </div>

                            <div class="section">
                                <h3>Import</h3>
                                <button class="btn-1 btn-import"
                                    onclick="handleFileImportJson('{{$table}}')">Json</button>
                                <button class="btn-1 btn-other-import"
                                    onclick="handleFileImportCSV('{{$table}}')">CSV</button>
                            </div>

                        </div>
                    </div>
                </li>
                {{end}}
            </ul>
            <div class="table-info" id="table-info">
            </div>
        </div>
        <div class="log-info" id="log-info"></div>
    </div>
    <script>
        function log(message) {
            var infoHtml = message + "\n";

            document.getElementById("log-info").innerHTML = infoHtml;
        }

        function applyFilter(tableName) {
            var selectedColumn = document.getElementById("column-select").value;
            var filterValue = document.getElementById("filter-value").value;

            var limit = document.getElementById("limit").value;
            var page = document.getElementById("page").value;

            var queryParams = {
                tableName: tableName,
                columnName: selectedColumn,
                filterValue: filterValue,
                limit: 0,
                page: 0
            };

            if (limit && limit.trim() !== "") {
                queryParams.limit = limit
            }

            if (page && page.trim() !== "") {
                queryParams.page = page
            }

            var queryString = Object.keys(queryParams).map(function (key) {
                return encodeURIComponent(key) + '=' + encodeURIComponent(queryParams[key]);
            }).join('&');

            // Выполнение действий с выбранным столбцом и значением фильтра
            console.log("Применение фильтра:");
            console.log("Таблица:", tableName);
            console.log("Столбец:", selectedColumn);
            console.log("Значение фильтра:", filterValue);

            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function () {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    var tableData = JSON.parse(xhr.responseText);
                    displayTableData(tableName, tableData, true);
                } else {
                    log(xhr.response);
                }
            };

            xhr.open("GET", "/{{.SchemaName}}/applyfilter?" + queryString, true);
            xhr.send();
        }

        function buildPanel(tableName, tableData, filterSet, insert) {
            const panelDiv = document.createElement('div');
            panelDiv.className = "panelDiv";
            // Транзакция
            const transactionDiv = document.createElement('div');
            transactionDiv.className = "transactionDiv";

            const transactionField = buildTransaction();
            transactionDiv.appendChild(transactionField);

            const addField = buildAddData(tableName, tableData, filterSet, insert);
            transactionDiv.appendChild(addField);
            panelDiv.appendChild(transactionDiv);

            const filterFullDiv = document.createElement('div');
            filterFullDiv.className = "filterFullDiv";
            const filterDiv = document.createElement('div');
            filterDiv.className = "filterDiv";
            // Фильтры
            const filterField = buildFilter(tableName, tableData, filterSet);
            filterDiv.appendChild(filterField);

            const collapsibleField = buildFilterOptions(tableName, tableData, filterSet);
            filterDiv.appendChild(collapsibleField);

            filterFullDiv.appendChild(filterDiv);

            const applyButton = document.createElement('button');
            applyButton.className = 'btn-1 btn-apply';
            applyButton.textContent = 'Apply Filter';

            const resetButton = document.createElement('button');
            resetButton.className = 'btn-1 btn-reset';
            resetButton.textContent = 'Reset Filter';
            if (filterSet) {
                resetButton.style.display = "inline"
            } else {
                resetButton.style.display = "none"
            }
            resetButton.onclick = () => getTableData(tableName);

            applyButton.addEventListener('click', function () {
                // Проверяем, заполнено ли хотя бы одно поле фильтра
                const filterInput = document.getElementById('filter-value').value;
                const limit = document.getElementById('limit').value;
                const page = document.getElementById('page').value;
                console.log(filterInput, limit, page);

                if ((filterInput !== null && filterInput.trim() !== '') ||
                    (limit !== null && limit.trim() !== '') ||
                    (page !== null && page.trim() !== '')) {
                    console.log(resetButton);
                    applyFilter(tableName);
                }
            });

            filterFullDiv.appendChild(applyButton);
            filterFullDiv.appendChild(resetButton);

            panelDiv.appendChild(filterFullDiv);

            return panelDiv;
        }

        function buildTransaction() {
            const filterDiv = document.createElement('div');

            const transactionButton = document.createElement('button');
            transactionButton.className = 'btn-1 btn-transaction';
            transactionButton.id = 'btn-transaction';
            transactionButton.onclick = startTransaction;
            transactionButton.textContent = 'Start Transaction';

            const rollbackButton = document.createElement('button');
            rollbackButton.className = 'btn-1 btn-rollback';
            rollbackButton.id = 'btn-rollback';
            rollbackButton.onclick = Rollback;
            rollbackButton.textContent = 'RollBack';

            const commitButton = document.createElement('button');
            commitButton.className = 'btn-1 btn-commit';
            commitButton.id = 'btn-commit';
            commitButton.onclick = Commit;
            commitButton.textContent = 'Commit';

            if (document.getElementById("btn-transaction") &&
                document.getElementById("btn-transaction").style.display == 'none') {
                transactionButton.style.display = 'none';
                rollbackButton.style.display = 'inline';
                commitButton.style.display = 'inline';
            } else {
                rollbackButton.style.display = 'none';
                commitButton.style.display = 'none';
            }

            filterDiv.appendChild(transactionButton);
            filterDiv.appendChild(rollbackButton);
            filterDiv.appendChild(commitButton);

            return filterDiv
        }

        function buildAddData(tableName, tableData, filterSet, insert) {
            const filterDiv = document.createElement('div');
            filterDiv.className = 'add-data';

            const tableDataString = encodeURIComponent(JSON.stringify(tableData));

            const addButton = document.createElement('button');
            addButton.className = 'btn-1 btn-add';
            addButton.textContent = 'Add Data';
            addButton.onclick = () => showAddDataForm(tableName, tableDataString, filterSet);

            console.log("insert", insert);
            const cancelButton = document.createElement('button');
            cancelButton.className = 'btn-1 btn-cancel';
            cancelButton.textContent = 'Cancel';
            cancelButton.onclick = () => closeAddDataForm(tableName, tableDataString, filterSet);

            if (insert) {
                cancelButton.style.display = 'inline';
                addButton.style.display = 'none';
            } else {
                addButton.style.display = 'inline';
                cancelButton.style.display = 'none';
            }

            filterDiv.appendChild(addButton);
            filterDiv.appendChild(cancelButton);

            return filterDiv
        }

        function buildFilter(tableName, tableData, filterSet) {
            const filterDiv = document.createElement('div');
            filterDiv.className = 'filter';

            const labelColumnSelect = document.createElement('label');
            labelColumnSelect.className = 'form-label';
            labelColumnSelect.htmlFor = 'column-select';
            labelColumnSelect.textContent = 'Select Column:';
            filterDiv.appendChild(labelColumnSelect);

            if (filterSet) {
                const filterValueInput = document.getElementById('column-select');
                filterDiv.appendChild(filterValueInput);
            } else {
                const columnSelect = document.createElement('select');
                columnSelect.id = 'column-select';
                columnSelect.className = 'form-select';
                tableData.Columns.forEach((column) => {
                    const option = document.createElement('option');
                    option.value = column;
                    option.textContent = column;
                    columnSelect.appendChild(option);
                });
                filterDiv.appendChild(columnSelect);
            }

            const labelFilterValue = document.createElement('label');
            labelFilterValue.className = 'form-label';
            labelFilterValue.htmlFor = 'filter-value';
            labelFilterValue.textContent = 'Filter Value:';
            filterDiv.appendChild(labelFilterValue);


            if (filterSet) {
                const filterValueInput = document.getElementById('filter-value');
                filterDiv.appendChild(filterValueInput);
            } else {
                const filterValueInput = document.createElement('input');
                filterValueInput.type = 'text';
                filterValueInput.id = 'filter-value';
                filterValueInput.className = 'form-input';
                filterDiv.appendChild(filterValueInput);
            }

            return filterDiv;
        }

        function buildFilterOptions(tableName, tableData, filterSet) {
            const filterDiv = document.createElement('div');

            const limitText = document.createElement('span');
            limitText.textContent = 'Limit: ';
            filterDiv.appendChild(limitText);

            if (filterSet) {
                const limitInput = document.getElementById('limit');
                const clonedLimitInput = limitInput.cloneNode(true);
                filterDiv.appendChild(clonedLimitInput);
            } else {
                const limitInput = document.createElement('input');
                limitInput.className = 'form-select';
                limitInput.id = 'limit';
                limitInput.type = 'number';
                limitInput.min = 1;
                limitInput.
                limitInput.addEventListener('input', function () {
                    if (parseInt(limitInput.value) <= 0 || isNaN(parseInt(limitInput.value))) {
                        limitInput.value = '';
                    }
                });
                filterDiv.appendChild(limitInput);
            }

            const pageText = document.createElement('span');
            pageText.textContent = 'Page: ';
            filterDiv.appendChild(pageText);

            if (filterSet) {
                const pageInput = document.getElementById('page');
                const clonedPageInput = pageInput.cloneNode(true);
                filterDiv.appendChild(clonedPageInput);
            } else {
                const pageInput = document.createElement('input');
                pageInput.className = 'form-select';
                pageInput.id = 'page';
                pageInput.type = 'number';
                pageInput.min = 1;
                pageInput.addEventListener('input', function () {
                    if (parseInt(pageInput.value) <= 0 || isNaN(parseInt(pageInput.value))) {
                        pageInput.value = '';
                    }
                });
                filterDiv.appendChild(pageInput);
            }

            return filterDiv;
        }

        function displayTableData(tableName, tableData, filterSet, insert) {
            console.log("displayTableData", tableData);
            console.log("insert", insert);

            const tableInfo = document.createElement('div');
            const heading = document.createElement('h2');
            heading.textContent = `Table Data: ${tableData.TableName}`;
            tableInfo.appendChild(heading);

            const filterField = buildPanel(tableName, tableData, filterSet, insert);
            tableInfo.appendChild(filterField);

            if (insert) {
                var newRow = [];
                tableData.Columns.forEach(function (column, index) {
                    var inputElement = document.createElement('input');
                    inputElement.className = 'insert-section';
                    inputElement.type = 'text';
                    inputElement.id = 'insert-value-' + index;

                    var cell = document.createElement('td');
                    cell.appendChild(inputElement);
                    newRow.push(cell);
                });

                if (tableData.Rows) {
                    tableData.Rows.unshift(newRow);
                } else {
                    tableData.Rows = [newRow];
                }
            } else {
                const addDataForm = document.createElement('div');
                addDataForm.id = 'addDataForm';
                addDataForm.style.display = 'none';

                const dataForm = document.createElement('form');
                dataForm.id = 'dataForm';
                dataForm.onsubmit = function () { addData(); return false; };

                const submitButton = document.createElement('button');
                submitButton.type = 'submit';
                submitButton.textContent = 'Submit';

                dataForm.appendChild(submitButton);
                addDataForm.appendChild(dataForm);
                tableInfo.appendChild(addDataForm);
            }

            if (tableData.Columns && tableData.Rows) {
                const tableDataContent = buildTableData(tableData, tableName);
                tableInfo.appendChild(tableDataContent);
            } else {
                const noDataMessage = document.createElement('p');
                noDataMessage.textContent = 'No data available for this table.';
                tableInfo.appendChild(noDataMessage);
            }

            const tableInfoContainer = document.getElementById("table-info");
            tableInfoContainer.innerHTML = '';
            tableInfoContainer.appendChild(tableInfo);
        }

        function buildTableData(tableData, tableName, editRowIndex) {
            const table = document.createElement('table');
            table.className = 'table-content';
            table.id = 'table-content';
            table.setAttribute('data-sort-direction', 'asc');

            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');

            if (tableName) {
                const actionHeader = document.createElement('th');
                actionHeader.className = 'action-column';
                actionHeader.textContent = 'Action';
                headerRow.appendChild(actionHeader);
            }

            tableData.Columns.forEach((column, columnIndex) => {
                const columnHeader = document.createElement('th');
                columnHeader.className = 'sortable';
                columnHeader.onclick = () => sortTable(columnIndex + (tableName ? 1 : 0));
                columnHeader.textContent = column;
                headerRow.appendChild(columnHeader);
            });

            thead.appendChild(headerRow);
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            tableData.Rows.forEach((row, rowIndex) => {
                const rowElement = document.createElement('tr');

                if (tableName) {
                    const actionCell = document.createElement('td');
                    if (rowIndex === 0 && row[0] instanceof HTMLElement && row[0].querySelector('input')) {
                        const insertButton = document.createElement('button');
                        insertButton.className = 'btn btn-insert';
                        insertButton.textContent = 'Insert';
                        insertButton.onclick = () => insertRow(tableName, encodeURIComponent(JSON.stringify(tableData.Columns)));
                        actionCell.appendChild(insertButton);
                    } else {
                        const actionDiv = document.createElement('div');
                        if (editRowIndex !== null && editRowIndex === rowIndex) {
                            console.log(editRowIndex, rowIndex);
                            const updateButton = document.createElement('button');
                            updateButton.className = 'btn btn-update';
                            updateButton.textContent = 'Submit';
                            updateButton.onclick = () => updateRow(tableName, rowIndex, encodeURIComponent(JSON.stringify(tableData)));
                            actionDiv.appendChild(updateButton);

                            const cancelButton = document.createElement('button');
                            cancelButton.className = 'btn btn-cancel';
                            cancelButton.textContent = 'Cancel';
                            cancelButton.onclick = () => updateRow(tableName, rowIndex, encodeURIComponent(JSON.stringify(tableData)), true);
                            actionDiv.appendChild(cancelButton);
                        } else {
                            const editButton = document.createElement('button');
                            editButton.className = 'btn btn-edit';
                            editButton.textContent = 'Edit';
                            editButton.onclick = () => editRow(tableName, rowIndex, encodeURIComponent(JSON.stringify(tableData)));
                            actionDiv.appendChild(editButton);

                            const deleteButton = document.createElement('button');
                            deleteButton.className = 'btn btn-delete';
                            deleteButton.textContent = 'Delete';
                            deleteButton.onclick = () => deleteRow(tableName, rowIndex, encodeURIComponent(JSON.stringify(tableData)));
                            actionDiv.appendChild(deleteButton);
                        }
                        actionCell.appendChild(actionDiv);
                    }
                    rowElement.appendChild(actionCell);
                }

                row.forEach((cell, cellIndex) => {
                    const cellElement = document.createElement('td');
                    if (editRowIndex !== null && editRowIndex === rowIndex) {
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.className = 'insert-section';
                        input.id = `update-value-${cellIndex}`;
                        input.value = cell;
                        cellElement.appendChild(input);
                    } else if (cell instanceof HTMLElement) {
                        cellElement.appendChild(cell);
                    } else {
                        if (cell) {
                            cellElement.textContent = cell;
                        } else {
                            cellElement.textContent = "null";
                        }
                    }
                    rowElement.appendChild(cellElement);
                });

                tbody.appendChild(rowElement);
            });

            table.appendChild(tbody);

            return table;
        }


        function sortTable(columnIndex) {
            var table = document.getElementById("table-content");
            var tbody = table.getElementsByTagName("tbody")[0];
            console.log(table, tbody);
            var rows = Array.from(tbody.rows);
            var sortDirection = table.getAttribute("data-sort-direction") === "asc" ? "desc" : "asc";
            table.setAttribute("data-sort-direction", sortDirection);

            console.log(`Sorting by column ${columnIndex} in ${sortDirection} order`);

            rows.sort(function (a, b) {
                var cellA = a.cells[columnIndex].innerText.toLowerCase();
                var cellB = b.cells[columnIndex].innerText.toLowerCase();

                var numA = parseFloat(cellA);
                var numB = parseFloat(cellB);

                if (!isNaN(numA) && !isNaN(numB)) {
                    cellA = numA;
                    cellB = numB;
                }

                if (sortDirection === "asc") {
                    return cellA > cellB ? 1 : cellA < cellB ? -1 : 0;
                } else {
                    return cellA < cellB ? 1 : cellA > cellB ? -1 : 0;
                }
            });

            rows.forEach(function (row) {
                tbody.appendChild(row);
            });

            console.log(tbody);

            console.log('Sorting completed');
        }

        // Функция для отображения формы ввода данных
        function showAddDataForm(tableName, tableDataString, filterSet) {
            var tableData = JSON.parse(decodeURIComponent(tableDataString));
            displayTableData(tableName, tableData, filterSet, true)
        }
        // Функция для закрытия формы ввода данных
        function closeAddDataForm(tableName, tableDataString, filterSet) {
            var tableData = JSON.parse(decodeURIComponent(tableDataString));
            displayTableData(tableName, tableData, filterSet)
        }

    </script>
</body>

</html>