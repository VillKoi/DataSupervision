<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Database Schema Visualization</title>
    <style>
        svg {
            width: 100%;
            height: 100vh;
            border: 1px solid black;
        }

        .table {
            fill: white;
            stroke: black;
            stroke-width: 2px;
        }

        .table text {
            font: 12px sans-serif;
        }

        .link {
            fill: none;
            stroke: black;
            stroke-width: 1px;
        }
    </style>
</head>
<body>
    <h1>Database Schema Visualization</h1>
    <svg id="schema"></svg>

    <script>
        const schema = JSON.parse('{{.SchemaJSON}}');

        const svg = document.getElementById('schema');
        const width = svg.clientWidth;
        const height = svg.clientHeight;

        const tableWidth = 150;
        const tableHeight = 100;
        const margin = 20;

        let xOffset = margin;
        let yOffset = margin;

        for (const [tableName, table] of Object.entries(schema.Tables)) {
            const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            group.setAttribute('transform', `translate(${xOffset}, ${yOffset})`);

            const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            rect.setAttribute('width', tableWidth);
            rect.setAttribute('height', tableHeight);
            rect.setAttribute('class', 'table');
            group.appendChild(rect);

            const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            text.setAttribute('x', 10);
            text.setAttribute('y', 20);
            text.textContent = tableName;
            group.appendChild(text);

            yOffset += tableHeight + margin;
            if (yOffset + tableHeight > height) {
                yOffset = margin;
                xOffset += tableWidth + margin;
            }

            svg.appendChild(group);
        }

        // Создание линий после создания всех таблиц
        for (const [tableName, table] of Object.entries(schema.Tables)) {
            for (const fk of table.ForeignKeys) {
                const source = document.querySelector(`text:contains("${tableName}")`);
                const target = document.querySelector(`text:contains("${fk.ReferencedTable}")`);

                if (source && target) {
                    const sourceRect = source.parentNode.querySelector('rect');
                    const targetRect = target.parentNode.querySelector('rect');

                    const x1 = parseFloat(sourceRect.getAttribute('x')) + tableWidth / 2;
                    const y1 = parseFloat(sourceRect.getAttribute('y')) + tableHeight;
                    const x2 = parseFloat(targetRect.getAttribute('x')) + tableWidth / 2;
                    const y2 = parseFloat(targetRect.getAttribute('y'));

                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', x1);
                    line.setAttribute('y1', y1);
                    line.setAttribute('x2', x2);
                    line.setAttribute('y2', y2);
                    line.setAttribute('class', 'link');
                    svg.appendChild(line);
                }
            }
        }
    </script>
</body>
</html>
